# Nginx configuration for FastAPI backend with protected file serving

upstream backend {
    server backend:8000;
}

server {
    listen 80;
    server_name _;

    client_max_body_size 100M;

    # 앱 프록시 (FastAPI/uvicorn)
    location / {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering on;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # 보호된 실제 파일 경로 (외부 접근 금지)
    location /_protected/ {
        internal;                         # 외부에서 직접 접근 불가
        # Try /var/app/media first, then fallback to /app/images
        alias /var/app/media/;            # 실제 루트 디렉토리
        add_header X-Accel-Buffering no;
        add_header Cache-Control "private, max-age=600";
        # 기본적으로 ETag/Last-Modified 동작
    }
    
    # Fallback for files stored in /app/images (when /var/app/media is not writable)
    # storage_path is "images/filename.jpg", so we need to serve from /app/images/images/
    location ~ ^/_protected/images/(.+)$ {
        internal;
        alias /app/images/images/$1;
        add_header X-Accel-Buffering no;
        add_header Cache-Control "private, max-age=600";
    }

    # Health check endpoint (optional)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

